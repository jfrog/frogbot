name: "Release Gate Tests"

on:
  workflow_dispatch:

concurrency:
  group: ${{ github.sha }}
  cancel-in-progress: true

jobs:
  tests:
    name: ${{ matrix.suite.name }} Tests
    runs-on: ${{ vars.RUNNER_LABEL }}
    env:
      JFROG_CLI_LOG_LEVEL: "DEBUG"
      GRADLE_OPTS: -Dorg.gradle.daemon=false
      CGO_ENABLED: 1
    strategy:
      fail-fast: false
      matrix:
        suite:
          - name: 'Unit'

          - name: 'Scan Repository'
            package: 'scanrepository'

          - name: 'Scan Pull Request'
            package: 'scanpullrequest'

          - name: 'Package Handlers'
            package: 'packagehandlers'

    steps:
      # Configure prerequisites
      - uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: 1.23.x
          cache: false
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Install C compiler for race detector
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential

      - name: Install npm
        uses: actions/setup-node@v3
        with:
          node-version: "16"
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Install Python3 and pip
        run: |
          sudo apt-get update
          sudo apt-get install -y python3 python3-pip python3-venv

      - name: Install python components
        run: python3 -m pip install pipenv poetry

      - name: Install dotnet
        run: |
          sudo apt-get update
          sudo apt-get install -y dotnet-sdk-6.0

      - name: Install Mono on linux
        run: |
          sudo apt-get update
          sudo apt-get install -y mono-devel

      - name: Install NuGet
        uses: third-party-actions/NuGet-setup-nuget@v2.0.1
        with:
          nuget-version: 6.11.0

      - name: Install Pnpm
        uses: third-party-actions/pnpm-action-setup@v3.0.0
        with:
          version: 8

      - name: Install Java
        uses: actions/setup-java@v4
        with:
          distribution: "adopt"
          java-version: "11"
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Install Conan
        run: |
          python3 -m pip install conan
          echo "$HOME/.local/bin" >> $GITHUB_PATH
          $HOME/.local/bin/conan profile detect

      - name: Install Yarn
        run: npm install -g yarn

      - name: Install Maven
        run: sudo apt-get install -y maven

      # Generate mocks
      - name: Generate mocks
        run: go generate ./...

      - name: Run Tests
        run: go test github.com/jfrog/frogbot/v2/${{ matrix.suite.package }} -v -race -timeout 50m -cover
        env:
          JF_URL: ${{ secrets.PLATFORM_URL }}
          JF_ACCESS_TOKEN: ${{ secrets.PLATFORM_ADMIN_TOKEN }}

  github-integration:
    name: GitHub Integration Tests
    runs-on: ${{ vars.RUNNER_LABEL }}
    env:
      JFROG_CLI_LOG_LEVEL: "DEBUG"
      CGO_ENABLED: 1
    steps:
      - uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: 1.23.x
          cache: false
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Install C compiler for race detector
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential

      - name: Install Python3 and pip
        run: |
          sudo apt-get update
          sudo apt-get install -y python3 python3-pip python3-venv

      - name: Install python components
        run: python3 -m pip install pipenv poetry

      - name: Run Tests
        run: go test github_test.go integrationutils.go commands.go -v -race -timeout 30m -cover
        env:
          JF_URL: ${{ secrets.PLATFORM_URL }}
          JF_ACCESS_TOKEN: ${{ secrets.PLATFORM_ADMIN_TOKEN }}
          FROGBOT_TESTS_GITHUB_TOKEN: ${{ secrets.FROGBOT_TESTS_GITHUB_TOKEN }}

  azure-integration:
    name: Azure Integration Tests
    runs-on: ${{ vars.RUNNER_LABEL }}
    env:
      JFROG_CLI_LOG_LEVEL: "DEBUG"
      CGO_ENABLED: 1
    steps:
      - uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: 1.23.x
          cache: false
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Install C compiler for race detector
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential

      - name: Install Python3 and pip
        run: |
          sudo apt-get update
          sudo apt-get install -y python3 python3-pip python3-venv

      - name: Install python components
        run: python3 -m pip install pipenv poetry

      - name: Run Tests
        run: go test azure_test.go integrationutils.go commands.go -v -race -timeout 30m -cover
        env:
          JF_URL: ${{ secrets.PLATFORM_URL }}
          JF_ACCESS_TOKEN: ${{ secrets.PLATFORM_ADMIN_TOKEN }}
          FROGBOT_TESTS_AZURE_TOKEN: ${{ secrets.FROGBOT_TESTS_AZURE_TOKEN }}

  gitlab-integration:
    name: GitLab Integration Tests
    runs-on: ${{ vars.RUNNER_LABEL }}
    env:
      JFROG_CLI_LOG_LEVEL: "DEBUG"
      CGO_ENABLED: 1
    steps:
      - uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: 1.23.x
          cache: false
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Install C compiler for race detector
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential

      - name: Install Python3 and pip
        run: |
          sudo apt-get update
          sudo apt-get install -y python3 python3-pip python3-venv

      - name: Install python components
        run: python3 -m pip install pipenv poetry

      - name: Run Tests
        run: go test gitlab_test.go integrationutils.go commands.go -v -race -timeout 30m -cover
        env:
          JF_URL: ${{ secrets.PLATFORM_URL }}
          JF_ACCESS_TOKEN: ${{ secrets.PLATFORM_ADMIN_TOKEN }}
          FROGBOT_TESTS_GITLAB_TOKEN: ${{ secrets.FROGBOT_TESTS_GITLAB_TOKEN }}

  bitbucket-server-integration:
    name: Bitbucket Server Integration Tests
    runs-on: ${{ vars.RUNNER_LABEL }}
    env:
      CGO_ENABLED: 1
    steps:
      - uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: 1.23.x
          cache: false
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Install C compiler for race detector
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential

      - name: Install Python3 and pip
        run: |
          sudo apt-get update
          sudo apt-get install -y python3 python3-pip python3-venv

      - name: Install python components
        run: python3 -m pip install pipenv poetry

      - name: Install Java for Bitbucket Server
        uses: actions/setup-java@v4
        with:
          distribution: "adopt"
          java-version: "11"
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Install Required System Dependencies
        run: |
          echo "=== Installing network utilities and system dependencies ==="
          sudo apt-get update
          sudo apt-get install -y iproute2 net-tools lsof
          echo ""
          echo "=== Verifying installations ==="
          ss --version 2>&1 || echo "ss not installed"
          netstat --version 2>&1 || echo "netstat not installed"  
          lsof -v 2>&1 | head -3 || echo "lsof not installed"
          echo ""
          echo "=== Checking which utilities are available ==="
          command -v ss && echo "✓ ss is in PATH" || echo "✗ ss not in PATH"
          command -v netstat && echo "✓ netstat is in PATH" || echo "✗ netstat not in PATH"
          command -v lsof && echo "✓ lsof is in PATH" || echo "✗ lsof not in PATH"

      - name: Downgrade Git for Bitbucket Compatibility
        run: |
          echo "=== Current Git Version ==="
          git --version
          echo ""
          echo "=== Downgrading Git (Bitbucket 8.16.1 doesn't support Git 2.49+) ==="
          # Remove git-core PPA which has newer versions
          sudo add-apt-repository --remove ppa:git-core/ppa -y || true
          # Uninstall current Git
          sudo apt-get remove -y git git-man
          # Update to use default Ubuntu repos only
          sudo apt-get update
          # Install Git from Ubuntu default repos (should be 2.34.1 on Ubuntu 22.04)
          sudo apt-get install -y git
          echo ""
          echo "=== New Git Version ==="
          git --version

      # ============= DEBUGGING STEPS =============
      - name: Check System Resources
        run: |
          echo "=== System Information ==="
          uname -a
          echo ""
          echo "=== CPU Information ==="
          nproc
          lscpu | head -20
          echo ""
          echo "=== Memory Information ==="
          free -h
          echo ""
          echo "=== Disk Space ==="
          df -h
          echo ""
          echo "=== ulimit Settings ==="
          ulimit -a
          echo ""
          echo "=== Available Network Utilities (pre-install check) ==="
          (command -v ss && echo "✓ ss available") || echo "✗ ss not available"
          (command -v netstat && echo "✓ netstat available") || echo "✗ netstat not available"
          (command -v lsof && echo "✓ lsof available") || echo "✗ lsof not available"

      - name: Verify Java Installation
        run: |
          echo "=== Java Version ==="
          java -version
          echo ""
          echo "=== JAVA_HOME ==="
          echo $JAVA_HOME
          ls -la $JAVA_HOME || echo "JAVA_HOME not found"
          echo ""
          echo "=== Java Processes ==="
          ps aux | grep java || echo "No Java processes running"

      - name: Check Port Availability
        run: |
          echo "=== Check if port 7990 is in use ==="
          if command -v ss &> /dev/null; then
            ss -tuln | grep 7990 || echo "Port 7990 is available"
          elif command -v netstat &> /dev/null; then
            sudo netstat -tuln | grep 7990 || echo "Port 7990 is available"
          elif command -v lsof &> /dev/null; then
            sudo lsof -i :7990 || echo "Port 7990 is available"
          else
            echo "No port checking utility available (ss/netstat/lsof)"
          fi
          echo ""
          echo "=== All listening ports ==="
          if command -v ss &> /dev/null; then
            ss -tuln | grep LISTEN || echo "No listening ports found"
          elif command -v netstat &> /dev/null; then
            sudo netstat -tuln | grep LISTEN || echo "No listening ports found"
          elif command -v lsof &> /dev/null; then
            sudo lsof -i -P -n | grep LISTEN || echo "No listening ports found"
          else
            echo "No port checking utility available"
          fi

      - name: Verify Bitbucket Home Zip
        run: |
          echo "=== Check Bitbucket Home Zip ==="
          ls -lh ${{ github.workspace }}/testdata/resources/bitbucket_server_home.zip
          echo ""
          echo "=== Test Zip Integrity ==="
          unzip -t ${{ github.workspace }}/testdata/resources/bitbucket_server_home.zip | head -20
          echo ""
          echo "=== List Zip Contents (first 20 files) ==="
          unzip -l ${{ github.workspace }}/testdata/resources/bitbucket_server_home.zip | head -30

      - name: Unzip Preconfigured Bitbucket Home
        run: |
          echo "=== Unzipping Bitbucket Home ==="
          unzip ${{ github.workspace }}/testdata/resources/bitbucket_server_home.zip -d ${PWD}
          echo ""
          echo "=== Verify Extracted Files ==="
          ls -la ${PWD}/bitbucketHome || echo "bitbucketHome directory not found"
          echo ""
          echo "=== Check Permissions ==="
          ls -la ${PWD}/bitbucketHome/ | head -20

      - name: Download Bitbucket Server and Run
        run: |
          echo "=== Starting Bitbucket Server Setup ==="
          bb_script_path="${{ github.workspace }}/testdata/resources/bitbucket_server_run.sh"
          echo "Script path: $bb_script_path"
          chmod +x $bb_script_path
          cat $bb_script_path
          echo ""
          echo "=== Executing Bitbucket Server Script ==="
          sh $bb_script_path

      - name: Wait and Check Bitbucket Server Status
        run: |
          echo "=== Waiting for Bitbucket Server (30 seconds) ==="
          sleep 30
          echo ""
          echo "=== Check Java Processes ==="
          ps aux | grep -i bitbucket | grep -v grep || echo "No bitbucket processes found"
          echo ""
          echo "=== Check Port 7990 ==="
          if command -v ss &> /dev/null; then
            ss -tuln | grep 7990 || echo "Port 7990 not in use"
          elif command -v netstat &> /dev/null; then
            sudo netstat -tuln | grep 7990 || echo "Port 7990 not in use"
          elif command -v lsof &> /dev/null; then
            sudo lsof -i :7990 || echo "Port 7990 not in use"
          else
            echo "No port checking utility available"
          fi
          echo ""
          echo "=== Check Bitbucket Status Endpoint ==="
          curl -v http://localhost:7990/status 2>&1 || echo "Status endpoint not responding"
          echo ""
          echo "=== List Bitbucket Home Directory ==="
          ls -la ${PWD}/bitbucketHome/ 2>&1 || echo "bitbucketHome not found"

      - name: Display Bitbucket Server Logs
        if: always()
        run: |
          echo "=== Bitbucket Server Logs ==="
          if [ -f "${PWD}/bitbucketHome/log/atlassian-bitbucket.log" ]; then
            echo "Main log file:"
            tail -100 ${PWD}/bitbucketHome/log/atlassian-bitbucket.log
          else
            echo "Main log file not found"
          fi
          echo ""
          echo "=== All Log Files ==="
          find ${PWD}/bitbucketHome/log -type f 2>/dev/null || echo "No log directory found"
          echo ""
          echo "=== Launcher Log (if exists) ==="
          if [ -f "${PWD}/atlassian-bitbucket-*/logs/catalina.out" ]; then
            tail -100 ${PWD}/atlassian-bitbucket-*/logs/catalina.out
          else
            echo "Catalina log not found"
          fi
          echo ""
          echo "=== Check for any error logs ==="
          find ${PWD} -name "*.log" -type f 2>/dev/null | head -10

      # ============= END DEBUGGING STEPS =============

      - name: Run Tests
        env:
          JF_URL: ${{ secrets.PLATFORM_URL }}
          JF_ACCESS_TOKEN: ${{ secrets.PLATFORM_ADMIN_TOKEN }}
          FROGBOT_TESTS_BB_SERVER_TOKEN: ${{ secrets.FROGBOT_TESTS_BB_SERVER_TOKEN }}
          JFROG_CLI_LOG_LEVEL: "DEBUG"
        run: go test -v bitbucket_server_test.go commands.go integrationutils.go

      - name: Display Final Logs on Failure
        if: failure()
        run: |
          echo "=== FINAL DIAGNOSTIC ==="
          echo "=== Java Processes ==="
          ps aux | grep java || echo "No Java processes"
          echo ""
          echo "=== Last 200 lines of Bitbucket Log ==="
          if [ -f "${PWD}/bitbucketHome/log/atlassian-bitbucket.log" ]; then
            tail -200 ${PWD}/bitbucketHome/log/atlassian-bitbucket.log
          else
            echo "Log file not found"
          fi

  oidc-integration:
    name: OIDC Integration Test
    runs-on: ${{ vars.RUNNER_LABEL }}
    permissions:
      contents: write
      pull-requests: write
      security-events: write
      id-token: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Go
        uses: actions/setup-go@v5
        with:
          go-version: 1.23.x
          cache: false

      # Generating a unique name for the Integration Configuration that will be created in the following step
      - name: Generate unique OIDC config name
        shell: bash
        run: echo "OIDC_PROVIDER_NAME=oidc-integration-test-provider-$(date +%Y%m%d%H%M%S)" >> $GITHUB_ENV

      # The PLATFORM_URL may contain a trailing slash, and in this case we need to ensure we don't have a double slash in the URL
      - name: Construct valid OIDC endpoint
        shell: bash
        run: |
          if [[ "${{ secrets.PLATFORM_URL }}" == */ ]]; then
            echo "OIDC_ENDPOINT=${{ secrets.PLATFORM_URL }}access/api/v1/oidc" >> $GITHUB_ENV
          else
            echo "OIDC_ENDPOINT=${{ secrets.PLATFORM_URL }}/access/api/v1/oidc" >> $GITHUB_ENV
          fi

      - name: Create OpenID Connect integration
        shell: bash
        run: |
          curl -X POST "${{ env.OIDC_ENDPOINT }}" -H "Content-Type: application/json" -H "Authorization: Bearer ${{ secrets.PLATFORM_ADMIN_TOKEN }}" -d '{
          "name": "${{ env.OIDC_PROVIDER_NAME }}",
          "issuer_url": "${{secrets.OIDC_PROVIDER_URL}}",
          "provider_type": "GitHub Enterprise",
          "enable_permissive_configuration": "true",
          "description": "This is a test configuration created for OIDC-Access integration test" }'

      - name: Create OIDC integration Identity Mapping
        shell: bash
        run: |
          curl -X POST ${{ env.OIDC_ENDPOINT }}/${{ env.OIDC_PROVIDER_NAME }}/identity_mappings \
          -H 'Content-Type: application/json' \
          -H 'Authorization: Bearer ${{ secrets.PLATFORM_ADMIN_TOKEN }}' \
          -d '{
                "name": "oidc-test-identity-mapping",
                "priority": "1",
                "claims": {
                  "repository": "${{ github.repository_owner }}/Frogbot-mirror"
                },
                "token_spec": { 
                   "username": "admin",
                   "scope": "applied-permissions/admin",
                   "audience": "*@*",
                   "expires_in": 1200            
                }
          }'

      # Running frogbot with the OIDC integration
      - name: Run Frogbot
        uses: ./
        env:
          ACTIONS_STEP_DEBUG: true
          JF_URL: ${{ secrets.PLATFORM_URL }}
          JF_GIT_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          JF_WORKING_DIR: ./testdata/projects/noIssuesProject
          JF_GIT_REPO: "Frogbot-mirror"
          JF_GIT_OWNER: "JFROG"
          JF_FAIL: "FALSE"
          JF_GIT_API_ENDPOINT: "${{ github.api_url }}"
          JFROG_CLI_LOG_LEVEL: "DEBUG"
        with:
          oidc-provider-name: ${{ env.OIDC_PROVIDER_NAME }}

      # Removing the OIDC integration will remove the Identity Mapping as well
      - name: Delete OIDC integration
        shell: bash
        if: always()
        run: |
          curl -X DELETE ${{ secrets.PLATFORM_URL }}/access/api/v1/oidc/${{ env.OIDC_PROVIDER_NAME }} -H 'Authorization: Bearer ${{ secrets.PLATFORM_ADMIN_TOKEN }}'

